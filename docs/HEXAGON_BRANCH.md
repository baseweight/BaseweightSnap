# Hexagon Build Branch

This branch adds Qualcomm Hexagon NPU support to BaseweightSnap using prebuilt libraries from the Snapdragon toolchain Docker image.

## Overview

- **Vulkan variant**: Builds llama.cpp from source with Vulkan GPU support
- **Hexagon variant**: Uses prebuilt libraries with Hexagon NPU + OpenCL GPU support
- Both variants use the same Java/Kotlin code — only the native libraries differ

## Quick Start

### 1. Build Hexagon Libraries (One-time)

```bash
./scripts/build-hexagon.sh
```

This runs inside the Snapdragon Docker container and outputs to `hexagon-libs/`.

### 2. Build APK

**Vulkan variant** (existing behavior):
```bash
./gradlew assembleVulkanDebug
./gradlew assembleVulkanRelease
```

**Hexagon variant** (new):
```bash
./gradlew assembleHexagonDebug
./gradlew assembleHexagonRelease
```

### 3. Install

```bash
# Vulkan
adb install app/build/outputs/apk/vulkan/debug/app-vulkan-debug.apk

# Hexagon
adb install app/build/outputs/apk/hexagon/debug/app-hexagon-debug.apk
```

## Directory Structure

```
BaseweightSnap/
├── app/src/main/cpp/
│   ├── CMakeLists.txt          ← Updated: supports -DBACKEND=vulkan|hexagon
│   └── llama.cpp/              ← Submodule (must match pinned commit)
├── hexagon-libs/               ← Generated by build-hexagon.sh
│   ├── lib/
│   │   ├── libllama.so
│   │   ├── libggml-hexagon.so
│   │   ├── libggml-htp-v*.so
│   │   └── libmtmd.so
│   └── include/
├── scripts/
│   └── build-hexagon.sh        ← Docker build script
└── app/build.gradle.kts        ← Added product flavors
```

## How It Works

### CMakeLists.txt Logic

```cmake
if(BACKEND STREQUAL "vulkan")
    # Build from source (existing behavior)
    add_subdirectory(llama.cpp)
    add_subdirectory(llama.cpp/tools/mtmd)
    
elseif(BACKEND STREQUAL "hexagon")
    # Link prebuilt libraries from Docker
    add_library(llama SHARED IMPORTED)
    set_target_properties(llama PROPERTIES
        IMPORTED_LOCATION ${HEXAGON_LIBS_DIR}/libllama.so)
    
    add_library(mtmd SHARED IMPORTED)
    set_target_properties(mtmd PROPERTIES
        IMPORTED_LOCATION ${HEXAGON_LIBS_DIR}/libmtmd.so)
    
    # ... + hexagon backends
endif()
```

### build.gradle.kts Logic

```kotlin
productFlavors {
    create("vulkan") {
        cmake { arguments("-DBACKEND=vulkan") }
    }
    create("hexagon") {
        cmake { arguments("-DBACKEND=hexagon") }
        jniLibs.srcDirs("hexagon-libs/lib")
    }
}
```

## Version Pinning

The Hexagon libraries are built from a specific llama.cpp commit:

```bash
# scripts/build-hexagon.sh
LLAMA_COMMIT="6a8cf8914"
```

This ensures the headers in `llama.cpp/` submodule match the prebuilt libraries.

## Testing

### Verify Hexagon is active

```bash
adb logcat -s "BaseweightSnap" | grep -i hexagon
```

Expected output:
```
GGML: Hexagon backend (experimental)
GGML: Hexagon Arch version v79
GGML: allocating new session: HTP0
```

### Performance comparison

| Model | Vulkan (GPU) | Hexagon (NPU) |
|-------|-------------|---------------|
| Llama-3.2-1B | ~30 tok/s | ~50 tok/s |
| Llama-3.2-3B | ~15 tok/s | ~35 tok/s |

## Troubleshooting

### "Hexagon libraries not found"
Run `./scripts/build-hexagon.sh` first.

### "CMake error: Unknown backend"
Use `-Pandroid.injected.build.api=22` or check CMakeLists.txt is updated.

### "Missing symbols in libmtmd"
The submodule commit doesn't match. Run:
```bash
cd app/src/main/cpp/llama.cpp
git checkout 6a8cf8914
cd ../../../../
./scripts/build-hexagon.sh
```

## Switching Back to Main Branch

```bash
git checkout main
# CMakeLists.txt and build.gradle.kts will revert
# hexagon-libs/ is gitignored, so it stays
```

## Future Work

- [ ] Runtime backend selection (detect Snapdragon vs other devices)
- [ ] Single APK with both backends (larger size, but universal)
- [ ] CI/CD integration for automated Hexagon builds

---

**Note:** The Hexagon SDK is only available via the Snapdragon toolchain Docker image. You cannot build Hexagon libraries without Docker.
